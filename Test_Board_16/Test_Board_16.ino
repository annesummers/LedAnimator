#include <Tlc5940.h>
#include <tlc_animations.h>
#include <tlc_config.h>
#include <tlc_fades.h>
#include <tlc_progmem_utils.h>
#include <tlc_servos.h>
#include <tlc_shifts.h>

#include <avr/pgmspace.h>

boolean gHaveCode;

PROGMEM prog_uint16_t gammaCorrection[] = {
  0,
  0, 0, 0, 0, 1, 1, 1, 2, 3, 3, 4, 5, 6, 7, 8, 9,11,12,13,15,
  17,19,21,23,25,27,29,32,34,37,40,42,45,48,52,55,58,62,

  66,69,73,77,81,85,90,94,99,104,108,113,118,123,
  129,134,140,145,151,157,163,169,175,182,188,
  195,202,209,216,223,230,237,245,253,

  260, 268, 276, 284, 293, 301, 310, 318, 327, 336, 345, 355, 364, 373, 383, 393, 403, 413, 423, 433, 444, 454, 465, 476, 487, 498, 509,
  520, 532, 543, 555, 567, 579, 591, 604, 616, 629, 642, 655, 668, 681, 694, 708, 721, 735, 749, 763,
  777, 791, 806, 820, 835, 850, 865, 880, 896, 911, 927, 942, 958, 974, 991, 1007,
  1023,1040,1057,1074,1091,1108,1125,1143,1161,1178,1196,1214,1233,1251,1270,
  1288,1307,1326,1345,1365,1384,1404,1423,1443,1463,1484,1504,1524,
  1545,1566,1587,1608,1629,1651,1672,1694,1716,1738,1760,1782,
  1805,1827,1850,1873,1896,1919,1943,1966,1990,2014,2038,
  2062,2087,2111,2136,2160,2185,2211,2236,2261,2287,
  2313,2338,2365,2391,2417,2444,2470,2497,2524,2551,
  2579,2606,2634,2662,2690,2718,2746,2774,2803,
  2832,2861,2890,2919,2949,2978,3008,3038,3068,
  3098,3128,3159,3190,3220,3251,3283,3314,
  3345,3377,3409,3441,3473,3505,3538,3571,
  3603,3636,3669,3703,3736,3770,3804,3838,
  3872,3906,3941,3975,4010,4045,4080};

PROGMEM prog_uchar animation1[] = {
86,
16,0,
1,
1,
100,100,
1,240,0,255,255,
2,34,250,0,255,235,
3,250,0,255,235,
4,7,1,255,214,
5,74,1,255,255,
6,62,1,255,214,
7,45,1,255,172,
8,62,1,255,214,
9,45,1,255,172,
10,25,1,255,190,
11,7,1,255,214,
12,25,1,255,190,
13,25,1,255,190,
14,7,1,255,214,
15,25,1,255,190,
16,45,1,255,172,
1,241,0,255,253,2,34,252,0,255,232,
3,252,0,255,232,4,9,1,255,211,5,72,1,255,250,6,64,1,255,219,7,47,1,255,177,8,64,1,255,219,9,47,1,255,
177,10,27,1,255,187,11,9,1,255,211,12,27,1,255,187,13,27,1,255,187,14,9,1,255,211,15,27,1,255,187,16,
47,1,255,177,1,242,0,255,250,2,34,253,0,255,229,3,253,0,255,229,4,11,1,255,208,5,71,1,255,245,6,65,1,
255,224,7,50,1,255,182,8,65,1,255,224,9,50,1,255,182,10,29,1,255,185,11,11,1,255,208,12,29,1,255,185,
13,29,1,255,185,14,11,1,255,208,15,29,1,255,185,16,50,1,255,182,1,243,0,255,248,2,34,255,0,255,227,3,
255,0,255,227,4,12,1,255,206,5,70,1,255,240,6,67,1,255,229,7,52,1,255,188,8,67,1,255,229,9,52,1,255,188,
10,32,1,255,182,11,12,1,255,206,12,32,1,255,182,13,32,1,255,182,14,12,1,255,206,15,32,1,255,182,16,52,
1,255,188,1,245,0,255,245,2,34,0,1,255,224,3,0,1,255,224,4,14,1,255,203,5,68,1,255,235,6,68,1,255,235,
7,54,1,255,193,8,68,1,255,235,9,54,1,255,193,10,34,1,255,179,11,14,1,255,203,12,34,1,255,179,13,34,1,
255,179,14,14,1,255,203,15,34,1,255,179,16,54,1,255,193,1,246,0,255,242,2,34,2,34,1,255,221,3,2,34,1,
255,221,4,16,1,255,200,5,67,1,255,230,6,70,1,255,240,7,56,1,255,198,8,70,1,255,240,9,56,1,255,198,10,
37,1,255,177,11,16,1,255,200,12,37,1,255,177,13,37,1,255,177,14,16,1,255,200,15,37,1,255,177,16,56,1,
255,198,1,247,0,255,240,2,34,4,1,255,219,3,4,1,255,219,4,18,1,255,198,5,65,1,255,225,6,71,1,255,245,7,
58,1,255,203,8,71,1,255,245,9,58,1,255,203,10,39,1,255,174,11,18,1,255,198,12,39,1,255,174,13,39,1,255,
174,14,18,1,255,198,15,39,1,255,174,16,58,1,255,203,1,249,0,255,237,2,34,5,1,255,216,3,5,1,255,216,4,
20,1,255,195,5,64,1,255,220,6,72,1,255,250,7,60,1,255,208,8,72,1,255,250,9,60,1,255,208,10,42,1,255,172,
11,20,1,255,195,12,42,1,255,172,13,42,1,255,172,14,20,1,255,195,15,42,1,255,172,16,60,1,255,208,1,250,
0,255,235,2,34,7,1,255,214,3,7,1,255,214,4,22,1,255,193,5,62,1,255,215,6,74,1,255,255,7,62,1,255,214,
8,74,1,255,255,9,62,1,255,214,10,45,1,255,172,11,22,1,255,193,12,45,1,255,172,13,45,1,255,172,14,22,1,
255,193,15,45,1,255,172,16,62,1,255,214,1,252,0,255,232,2,34,9,1,255,211,3,9,1,255,211,4,25,1,255,190,
5,60,1,255,209,6,72,1,255,250,7,64,1,255,219,8,72,1,255,250,9,64,1,255,219,10,47,1,255,177,11,25,1,255,
190,12,47,1,255,177,13,47,1,255,177,14,25,1,255,190,15,47,1,255,177,16,64,1,255,219,1,253,0,255,229,2,34,
11,1,255,208,3,11,1,255,208,4,27,1,255,187,5,59,1,255,204,6,71,1,255,245,7,65,1,255,224,8,71,1,255,245,
9,65,1,255,224,10,50,1,255,182,11,27,1,255,187,12,50,1,255,182,13,50,1,255,182,14,27,1,255,187,15,50,
1,255,182,16,65,1,255,224,1,255,0,255,227,2,34,12,1,255,206,3,12,1,255,206,4,29,1,255,185,5,57,1,255,
199,6,70,1,255,240,7,67,1,255,229,8,70,1,255,240,9,67,1,255,229,10,52,1,255,188,11,29,1,255,185,12,52,
1,255,188,13,52,1,255,188,14,29,1,255,185,15,52,1,255,188,16,67,1,255,229,1,0,1,255,224,2,34,14,1,255,
203,3,14,1,255,203,4,32,1,255,182,5,55,1,255,194,6,68,1,255,235,7,68,1,255,235,8,68,1,255,235,9,68,1,
255,235,10,54,1,255,193,11,32,1,255,182,12,54,1,255,193,13,54,1,255,193,14,32,1,255,182,15,54,1,255,193,
16,68,1,255,235,1,2,34,1,255,221,2,34,16,1,255,200,3,16,1,255,200,4,34,1,255,179,5,53,1,255,189,6,67,
1,255,230,7,70,1,255,240,8,67,1,255,230,9,70,1,255,240,10,56,1,255,198,11,34,1,255,179,12,56,1,255,198,
13,56,1,255,198,14,34,1,255,179,15,56,1,255,198,16,70,1,255,240,1,4,1,255,219,2,34,18,1,255,198,3,18,
1,255,198,4,37,1,255,177,5,50,1,255,184,6,65,1,255,225,7,71,1,255,245,8,65,1,255,225,9,71,1,255,245,10,
58,1,255,203,11,37,1,255,177,12,58,1,255,203,13,58,1,255,203,14,37,1,255,177,15,58,1,255,203,16,71,1,
255,245,1,5,1,255,216,2,34,20,1,255,195,3,20,1,255,195,4,39,1,255,174,5,48,1,255,179,6,64,1,255,220,7,
72,1,255,250,8,64,1,255,220,9,72,1,255,250,10,60,1,255,208,11,39,1,255,174,12,60,1,255,208,13,60,1,255,
208,14,39,1,255,174,15,60,1,255,208,16,72,1,255,250,1,7,1,255,214,2,34,22,1,255,193,3,22,1,255,193,4,
42,1,255,172,5,45,1,255,174,6,62,1,255,215,7,74,1,255,255,8,62,1,255,215,9,74,1,255,255,10,62,1,255,214,
11,42,1,255,172,12,62,1,255,214,13,62,1,255,214,14,42,1,255,172,15,62,1,255,214,16,74,1,255,255,1,9,1,
255,211,2,34,25,1,255,190,3,25,1,255,190,4,45,1,255,172,5,43,1,255,171,6,60,1,255,209,7,72,1,255,250,
8,60,1,255,209,9,72,1,255,250,10,64,1,255,219,11,45,1,255,172,12,64,1,255,219,13,64,1,255,219,14,45,1,
255,172,15,64,1,255,219,16,72,1,255,250,1,11,1,255,208,2,34,27,1,255,187,3,27,1,255,187,4,47,1,255,177,
5,40,1,255,173,6,59,1,255,204,7,71,1,255,245,8,59,1,255,204,9,71,1,255,245,10,65,1,255,224,11,47,1,255,
177,12,65,1,255,224,13,65,1,255,224,14,47,1,255,177,15,65,1,255,224,16,71,1,255,245,1,12,1,255,206,2,34,
29,1,255,185,3,29,1,255,185,4,50,1,255,182,5,38,1,255,176,6,57,1,255,199,7,70,1,255,240,8,57,1,255,199,
9,70,1,255,240,10,67,1,255,229,11,50,1,255,182,12,67,1,255,229,13,67,1,255,229,14,50,1,255,182,15,67,
1,255,229,16,70,1,255,240,1,14,1,255,203,2,34,32,1,255,182,3,32,1,255,182,4,52,1,255,188,5,35,1,255,178,
6,55,1,255,194,7,68,1,255,235,8,55,1,255,194,9,68,1,255,235,10,68,1,255,235,11,52,1,255,188,12,68,1,255,
235,13,68,1,255,235,14,52,1,255,188,15,68,1,255,235,16,68,1,255,235,1,16,1,255,200,2,34,34,1,255,179,
3,34,1,255,179,4,54,1,255,193,5,33,1,255,181,6,53,1,255,189,7,67,1,255,230,8,53,1,255,189,9,67,1,255,
230,10,70,1,255,240,11,54,1,255,193,12,70,1,255,240,13,70,1,255,240,14,54,1,255,193,15,70,1,255,240,16,
67,1,255,230,1,18,1,255,198,2,34,37,1,255,177,3,37,1,255,177,4,56,1,255,198,5,30,1,255,184,6,50,1,255,
184,7,65,1,255,225,8,50,1,255,184,9,65,1,255,225,10,71,1,255,245,11,56,1,255,198,12,71,1,255,245,13,71,
1,255,245,14,56,1,255,198,15,71,1,255,245,16,65,1,255,225,1,20,1,255,195,2,34,39,1,255,174,3,39,1,255,
174,4,58,1,255,203,5,28,1,255,186,6,48,1,255,179,7,64,1,255,220,8,48,1,255,179,9,64,1,255,220,10,72,1,
255,250,11,58,1,255,203,12,72,1,255,250,13,72,1,255,250,14,58,1,255,203,15,72,1,255,250,16,64,1,255,220,
1,22,1,255,193,2,34,42,1,255,172,3,42,1,255,172,4,60,1,255,208,5,26,1,255,189,6,45,1,255,174,7,62,1,255,
215,8,45,1,255,174,9,62,1,255,215,10,74,1,255,255,11,60,1,255,208,12,74,1,255,255,13,74,1,255,255,14,
60,1,255,208,15,74,1,255,255,16,62,1,255,215,1,25,1,255,190,2,34,45,1,255,172,3,45,1,255,172,4,62,1,255,
214,5,24,1,255,191,6,43,1,255,171,7,60,1,255,209,8,43,1,255,171,9,60,1,255,209,10,72,1,255,250,11,62,
1,255,214,12,72,1,255,250,13,72,1,255,250,14,62,1,255,214,15,72,1,255,250,16,60,1,255,209,1,27,1,255,
187,2,34,47,1,255,177,3,47,1,255,177,4,64,1,255,219,5,21,1,255,194,6,40,1,255,173,7,59,1,255,204,8,40,
1,255,173,9,59,1,255,204,10,71,1,255,245,11,64,1,255,219,12,71,1,255,245,13,71,1,255,245,14,64,1,255,
219,15,71,1,255,245,16,59,1,255,204,1,29,1,255,185,2,34,50,1,255,182,3,50,1,255,182,4,65,1,255,224,5,
19,1,255,196,6,38,1,255,176,7,57,1,255,199,8,38,1,255,176,9,57,1,255,199,10,70,1,255,240,11,65,1,255,
224,12,70,1,255,240,13,70,1,255,240,14,65,1,255,224,15,70,1,255,240,16,57,1,255,199,1,32,1,255,182,2,34,
52,1,255,188,3,52,1,255,188,4,67,1,255,229,5,17,1,255,199,6,35,1,255,178,7,55,1,255,194,8,35,1,255,178,
9,55,1,255,194,10,68,1,255,235,11,67,1,255,229,12,68,1,255,235,13,68,1,255,235,14,67,1,255,229,15,68,
1,255,235,16,55,1,255,194,1,34,1,255,179,2,34,54,1,255,193,3,54,1,255,193,4,68,1,255,235,5,15,1,255,202,
6,33,1,255,181,7,53,1,255,189,8,33,1,255,181,9,53,1,255,189,10,67,1,255,230,11,68,1,255,235,12,67,1,255,
230,13,67,1,255,230,14,68,1,255,235,15,67,1,255,230,16,53,1,255,189,1,37,1,255,177,2,34,56,1,255,198,
3,56,1,255,198,4,70,1,255,240,5,14,1,255,204,6,30,1,255,184,7,50,1,255,184,8,30,1,255,184,9,50,1,255,
184,10,65,1,255,225,11,70,1,255,240,12,65,1,255,225,13,65,1,255,225,14,70,1,255,240,15,65,1,255,225,16,
50,1,255,184,1,39,1,255,174,2,34,58,1,255,203,3,58,1,255,203,4,71,1,255,245,5,12,1,255,207,6,28,1,255,
186,7,48,1,255,179,8,28,1,255,186,9,48,1,255,179,10,64,1,255,220,11,71,1,255,245,12,64,1,255,220,13,64,
1,255,220,14,71,1,255,245,15,64,1,255,220,16,48,1,255,179,1,42,1,255,172,2,34,60,1,255,208,3,60,1,255,
208,4,72,1,255,250,5,10,1,255,209,6,26,1,255,189,7,45,1,255,174,8,26,1,255,189,9,45,1,255,174,10,62,1,
255,215,11,72,1,255,250,12,62,1,255,215,13,62,1,255,215,14,72,1,255,250,15,62,1,255,215,16,45,1,255,174,
1,45,1,255,172,2,34,62,1,255,214,3,62,1,255,214,4,74,1,255,255,5,8,1,255,212,6,24,1,255,191,7,43,1,255,
171,8,24,1,255,191,9,43,1,255,171,10,60,1,255,209,11,74,1,255,255,12,60,1,255,209,13,60,1,255,209,14,
74,1,255,255,15,60,1,255,209,16,43,1,255,171,1,47,1,255,177,2,34,64,1,255,219,3,64,1,255,219,4,72,1,255,
250,5,6,1,255,214,6,21,1,255,194,7,40,1,255,173,8,21,1,255,194,9,40,1,255,173,10,59,1,255,204,11,72,1,
255,250,12,59,1,255,204,13,59,1,255,204,14,72,1,255,250,15,59,1,255,204,16,40,1,255,173,1,50,1,255,182,
2,34,65,1,255,224,3,65,1,255,224,4,71,1,255,245,5,5,1,255,217,6,19,1,255,196,7,38,1,255,176,8,19,1,255,
196,9,38,1,255,176,10,57,1,255,199,11,71,1,255,245,12,57,1,255,199,13,57,1,255,199,14,71,1,255,245,15,
57,1,255,199,16,38,1,255,176,1,52,1,255,188,2,34,67,1,255,229,3,67,1,255,229,4,70,1,255,240,5,3,1,255,
220,6,17,1,255,199,7,35,1,255,178,8,17,1,255,199,9,35,1,255,178,10,55,1,255,194,11,70,1,255,240,12,55,
1,255,194,13,55,1,255,194,14,70,1,255,240,15,55,1,255,194,16,35,1,255,178,1,54,1,255,193,2,34,68,1,255,
235,3,68,1,255,235,4,68,1,255,235,5,1,1,255,222,6,15,1,255,202,7,33,1,255,181,8,15,1,255,202,9,33,1,255,
181,10,53,1,255,189,11,68,1,255,235,12,53,1,255,189,13,53,1,255,189,14,68,1,255,235,15,53,1,255,189,16,
33,1,255,181,1,56,1,255,198,2,34,70,1,255,240,3,70,1,255,240,4,67,1,255,230,5,0,1,255,225,6,14,1,255,
204,7,30,1,255,184,8,14,1,255,204,9,30,1,255,184,10,50,1,255,184,11,67,1,255,230,12,50,1,255,184,13,50,
1,255,184,14,67,1,255,230,15,50,1,255,184,16,30,1,255,184,1,58,1,255,203,2,34,71,1,255,245,3,71,1,255,
245,4,65,1,255,225,5,254,0,255,227,6,12,1,255,207,7,28,1,255,186,8,12,1,255,207,9,28,1,255,186,10,48,
1,255,179,11,65,1,255,225,12,48,1,255,179,13,48,1,255,179,14,65,1,255,225,15,48,1,255,179,16,28,1,255,
186,1,60,1,255,208,2,34,72,1,255,250,3,72,1,255,250,4,64,1,255,220,5,253,0,255,230,6,10,1,255,209,7,26,
1,255,189,8,10,1,255,209,9,26,1,255,189,10,45,1,255,174,11,64,1,255,220,12,45,1,255,174,13,45,1,255,174,
14,64,1,255,220,15,45,1,255,174,16,26,1,255,189,1,62,1,255,214,2,34,74,1,255,255,3,74,1,255,255,4,62,
1,255,215,5,251,0,255,232,6,8,1,255,212,7,24,1,255,191,8,8,1,255,212,9,24,1,255,191,10,43,1,255,171,11,
62,1,255,215,12,43,1,255,171,13,43,1,255,171,14,62,1,255,215,15,43,1,255,171,16,24,1,255,191,1,64,1,255,
219,2,34,72,1,255,250,3,72,1,255,250,4,60,1,255,209,5,250,0,255,235,6,6,1,255,214,7,21,1,255,194,8,6,
1,255,214,9,21,1,255,194,10,40,1,255,173,11,60,1,255,209,12,40,1,255,173,13,40,1,255,173,14,60,1,255,
209,15,40,1,255,173,16,21,1,255,194,1,65,1,255,224,2,34,71,1,255,245,3,71,1,255,245,4,59,1,255,204,5,
249,0,255,238,6,5,1,255,217,7,19,1,255,196,8,5,1,255,217,9,19,1,255,196,10,38,1,255,176,11,59,1,255,204,
12,38,1,255,176,13,38,1,255,176,14,59,1,255,204,15,38,1,255,176,16,19,1,255,196,1,67,1,255,229,2,34,70,
1,255,240,3,70,1,255,240,4,57,1,255,199,5,247,0,255,240,6,3,1,255,220,7,17,1,255,199,8,3,1,255,220,9,
17,1,255,199,10,35,1,255,178,11,57,1,255,199,12,35,1,255,178,13,35,1,255,178,14,57,1,255,199,15,35,1,
255,178,16,17,1,255,199,1,68,1,255,235,2,34,68,1,255,235,3,68,1,255,235,4,55,1,255,194,5,246,0,255,243,
6,1,1,255,222,7,15,1,255,202,8,1,1,255,222,9,15,1,255,202,10,33,1,255,181,11,55,1,255,194,12,33,1,255,
181,13,33,1,255,181,14,55,1,255,194,15,33,1,255,181,16,15,1,255,202,1,70,1,255,240,2,34,67,1,255,230,
3,67,1,255,230,4,53,1,255,189,5,245,0,255,245,6,0,1,255,225,7,14,1,255,204,8,0,1,255,225,9,14,1,255,204,
10,30,1,255,184,11,53,1,255,189,12,30,1,255,184,13,30,1,255,184,14,53,1,255,189,15,30,1,255,184,16,14,
1,255,204,1,71,1,255,245,2,34,65,1,255,225,3,65,1,255,225,4,50,1,255,184,5,243,0,255,248,6,254,0,255,
227,7,12,1,255,207,8,254,0,255,227,9,12,1,255,207,10,28,1,255,186,11,50,1,255,184,12,28,1,255,186,13,
28,1,255,186,14,50,1,255,184,15,28,1,255,186,16,12,1,255,207,1,72,1,255,250,2,34,64,1,255,220,3,64,1,
255,220,4,48,1,255,179,5,242,0,255,250,6,253,0,255,230,7,10,1,255,209,8,253,0,255,230,9,10,1,255,209,
10,26,1,255,189,11,48,1,255,179,12,26,1,255,189,13,26,1,255,189,14,48,1,255,179,15,26,1,255,189,16,10,
1,255,209,1,74,1,255,255,2,34,62,1,255,215,3,62,1,255,215,4,45,1,255,174,5,241,0,255,253,6,251,0,255,
232,7,8,1,255,212,8,251,0,255,232,9,8,1,255,212,10,24,1,255,191,11,45,1,255,174,12,24,1,255,191,13,24,
1,255,191,14,45,1,255,174,15,24,1,255,191,16,8,1,255,212,1,72,1,255,250,2,34,60,1,255,209,3,60,1,255,
209,4,43,1,255,171,5,240,0,255,255,6,250,0,255,235,7,6,1,255,214,8,250,0,255,235,9,6,1,255,214,10,21,
1,255,194,11,43,1,255,171,12,21,1,255,194,13,21,1,255,194,14,43,1,255,171,15,21,1,255,194,16,6,1,255,
214,1,71,1,255,245,2,34,59,1,255,204,3,59,1,255,204,4,40,1,255,173,5,241,0,255,253,6,249,0,255,238,7,
5,1,255,217,8,249,0,255,238,9,5,1,255,217,10,19,1,255,196,11,40,1,255,173,12,19,1,255,196,13,19,1,255,
196,14,40,1,255,173,15,19,1,255,196,16,5,1,255,217,1,70,1,255,240,2,34,57,1,255,199,3,57,1,255,199,4,
38,1,255,176,5,242,0,255,250,6,247,0,255,240,7,3,1,255,220,8,247,0,255,240,9,3,1,255,220,10,17,1,255,
199,11,38,1,255,176,12,17,1,255,199,13,17,1,255,199,14,38,1,255,176,15,17,1,255,199,16,3,1,255,220,1,
68,1,255,235,2,34,55,1,255,194,3,55,1,255,194,4,35,1,255,178,5,243,0,255,248,6,246,0,255,243,7,1,1,255,
222,8,246,0,255,243,9,1,1,255,222,10,15,1,255,202,11,35,1,255,178,12,15,1,255,202,13,15,1,255,202,14,
35,1,255,178,15,15,1,255,202,16,1,1,255,222,1,67,1,255,230,2,34,53,1,255,189,3,53,1,255,189,4,33,1,255,
181,5,245,0,255,245,6,245,0,255,245,7,0,1,255,225,8,245,0,255,245,9,0,1,255,225,10,14,1,255,204,11,33,
1,255,181,12,14,1,255,204,13,14,1,255,204,14,33,1,255,181,15,14,1,255,204,16,0,1,255,225,1,65,1,255,225,
2,34,50,1,255,184,3,50,1,255,184,4,30,1,255,184,5,246,0,255,242,6,243,0,255,248,7,254,0,255,227,8,243,
0,255,248,9,254,0,255,227,10,12,1,255,207,11,30,1,255,184,12,12,1,255,207,13,12,1,255,207,14,30,1,255,
184,15,12,1,255,207,16,254,0,255,227,1,64,1,255,220,2,34,48,1,255,179,3,48,1,255,179,4,28,1,255,186,5,
247,0,255,240,6,242,0,255,250,7,253,0,255,230,8,242,0,255,250,9,253,0,255,230,10,10,1,255,209,11,28,1,
255,186,12,10,1,255,209,13,10,1,255,209,14,28,1,255,186,15,10,1,255,209,16,253,0,255,230,1,62,1,255,215,
2,34,45,1,255,174,3,45,1,255,174,4,26,1,255,189,5,249,0,255,237,6,241,0,255,253,7,251,0,255,232,8,241,
0,255,253,9,251,0,255,232,10,8,1,255,212,11,26,1,255,189,12,8,1,255,212,13,8,1,255,212,14,26,1,255,189,
15,8,1,255,212,16,251,0,255,232,1,60,1,255,209,2,34,43,1,255,171,3,43,1,255,171,4,24,1,255,191,5,250,
0,255,235,6,240,0,255,255,7,250,0,255,235,8,240,0,255,255,9,250,0,255,235,10,6,1,255,214,11,24,1,255,
191,12,6,1,255,214,13,6,1,255,214,14,24,1,255,191,15,6,1,255,214,16,250,0,255,235,1,59,1,255,204,2,34,
40,1,255,173,3,40,1,255,173,4,21,1,255,194,5,252,0,255,232,6,241,0,255,253,7,249,0,255,238,8,241,0,255,
253,9,249,0,255,238,10,5,1,255,217,11,21,1,255,194,12,5,1,255,217,13,5,1,255,217,14,21,1,255,194,15,5,
1,255,217,16,249,0,255,238,1,57,1,255,199,2,34,38,1,255,176,3,38,1,255,176,4,19,1,255,196,5,253,0,255,
229,6,242,0,255,250,7,247,0,255,240,8,242,0,255,250,9,247,0,255,240,10,3,1,255,220,11,19,1,255,196,12,
3,1,255,220,13,3,1,255,220,14,19,1,255,196,15,3,1,255,220,16,247,0,255,240,1,55,1,255,194,2,34,35,1,255,
178,3,35,1,255,178,4,17,1,255,199,5,255,0,255,227,6,243,0,255,248,7,246,0,255,243,8,243,0,255,248,9,246,
0,255,243,10,1,1,255,222,11,17,1,255,199,12,1,1,255,222,13,1,1,255,222,14,17,1,255,199,15,1,1,255,222,
16,246,0,255,243,1,53,1,255,189,2,34,33,1,255,181,3,33,1,255,181,4,15,1,255,202,5,0,1,255,224,6,245,0,
255,245,7,245,0,255,245,8,245,0,255,245,9,245,0,255,245,10,0,1,255,225,11,15,1,255,202,12,0,1,255,225,
13,0,1,255,225,14,15,1,255,202,15,0,1,255,225,16,245,0,255,245,1,50,1,255,184,2,34,30,1,255,184,3,30,
1,255,184,4,14,1,255,204,5,2,34,1,255,221,6,246,0,255,242,7,243,0,255,248,8,246,0,255,242,9,243,0,255,
248,10,254,0,255,227,11,14,1,255,204,12,254,0,255,227,13,254,0,255,227,14,14,1,255,204,15,254,0,255,227,
16,243,0,255,248,1,48,1,255,179,2,34,28,1,255,186,3,28,1,255,186,4,12,1,255,207,5,4,1,255,219,6,247,0,
255,240,7,242,0,255,250,8,247,0,255,240,9,242,0,255,250,10,253,0,255,230,11,12,1,255,207,12,253,0,255,
230,13,253,0,255,230,14,12,1,255,207,15,253,0,255,230,16,242,0,255,250,1,45,1,255,174,2,34,26,1,255,189,
3,26,1,255,189,4,10,1,255,209,5,5,1,255,216,6,249,0,255,237,7,241,0,255,253,8,249,0,255,237,9,241,0,255,
253,10,251,0,255,232,11,10,1,255,209,12,251,0,255,232,13,251,0,255,232,14,10,1,255,209,15,251,0,255,232,
16,241,0,255,253,1,43,1,255,171,2,34,24,1,255,191,3,24,1,255,191,4,8,1,255,212,5,7,1,255,214,6,250,0,
255,235,7,240,0,255,255,8,250,0,255,235,9,240,0,255,255,10,250,0,255,235,11,8,1,255,212,12,250,0,255,
235,13,250,0,255,235,14,8,1,255,212,15,250,0,255,235,16,240,0,255,255,1,40,1,255,173,2,34,21,1,255,194,
3,21,1,255,194,4,6,1,255,214,5,9,1,255,211,6,252,0,255,232,7,241,0,255,253,8,252,0,255,232,9,241,0,255,
253,10,249,0,255,238,11,6,1,255,214,12,249,0,255,238,13,249,0,255,238,14,6,1,255,214,15,249,0,255,238,
16,241,0,255,253,1,38,1,255,176,2,34,19,1,255,196,3,19,1,255,196,4,5,1,255,217,5,11,1,255,208,6,253,0,
255,229,7,242,0,255,250,8,253,0,255,229,9,242,0,255,250,10,247,0,255,240,11,5,1,255,217,12,247,0,255,
240,13,247,0,255,240,14,5,1,255,217,15,247,0,255,240,16,242,0,255,250,1,35,1,255,178,2,34,17,1,255,199,
3,17,1,255,199,4,3,1,255,220,5,12,1,255,206,6,255,0,255,227,7,243,0,255,248,8,255,0,255,227,9,243,0,255,
248,10,246,0,255,243,11,3,1,255,220,12,246,0,255,243,13,246,0,255,243,14,3,1,255,220,15,246,0,255,243,
16,243,0,255,248,1,33,1,255,181,2,34,15,1,255,202,3,15,1,255,202,4,1,1,255,222,5,14,1,255,203,6,0,1,255,
224,7,245,0,255,245,8,0,1,255,224,9,245,0,255,245,10,245,0,255,245,11,1,1,255,222,12,245,0,255,245,13,
245,0,255,245,14,1,1,255,222,15,245,0,255,245,16,245,0,255,245,1,30,1,255,184,2,34,14,1,255,204,3,14,
1,255,204,4,0,1,255,225,5,16,1,255,200,6,2,34,1,255,221,7,246,0,255,242,8,2,34,1,255,221,9,246,0,255,
242,10,243,0,255,248,11,0,1,255,225,12,243,0,255,248,13,243,0,255,248,14,0,1,255,225,15,243,0,255,248,
16,246,0,255,242,1,28,1,255,186,2,34,12,1,255,207,3,12,1,255,207,4,254,0,255,227,5,18,1,255,198,6,4,1,
255,219,7,247,0,255,240,8,4,1,255,219,9,247,0,255,240,10,242,0,255,250,11,254,0,255,227,12,242,0,255,
250,13,242,0,255,250,14,254,0,255,227,15,242,0,255,250,16,247,0,255,240,1,26,1,255,189,2,34,10,1,255,
209,3,10,1,255,209,4,253,0,255,230,5,20,1,255,195,6,5,1,255,216,7,249,0,255,237,8,5,1,255,216,9,249,0,
255,237,10,241,0,255,253,11,253,0,255,230,12,241,0,255,253,13,241,0,255,253,14,253,0,255,230,15,241,0,
255,253,16,249,0,255,237,1,24,1,255,191,2,34,8,1,255,212,3,8,1,255,212,4,251,0,255,232,5,22,1,255,193,
6,7,1,255,214,7,250,0,255,235,8,7,1,255,214,9,250,0,255,235,10,240,0,255,255,11,251,0,255,232,12,240,
0,255,255,13,240,0,255,255,14,251,0,255,232,15,240,0,255,255,16,250,0,255,235,1,21,1,255,194,2,34,6,1,
255,214,3,6,1,255,214,4,250,0,255,235,5,25,1,255,190,6,9,1,255,211,7,252,0,255,232,8,9,1,255,211,9,252,
0,255,232,10,241,0,255,253,11,250,0,255,235,12,241,0,255,253,13,241,0,255,253,14,250,0,255,235,15,241,
0,255,253,16,252,0,255,232,1,19,1,255,196,2,34,5,1,255,217,3,5,1,255,217,4,249,0,255,238,5,27,1,255,187,
6,11,1,255,208,7,253,0,255,229,8,11,1,255,208,9,253,0,255,229,10,242,0,255,250,11,249,0,255,238,12,242,
0,255,250,13,242,0,255,250,14,249,0,255,238,15,242,0,255,250,16,253,0,255,229,1,17,1,255,199,2,34,3,1,
255,220,3,3,1,255,220,4,247,0,255,240,5,29,1,255,185,6,12,1,255,206,7,255,0,255,227,8,12,1,255,206,9,
255,0,255,227,10,243,0,255,248,11,247,0,255,240,12,243,0,255,248,13,243,0,255,248,14,247,0,255,240,15,
243,0,255,248,16,255,0,255,227,1,15,1,255,202,2,34,1,1,255,222,3,1,1,255,222,4,246,0,255,243,5,32,1,255,
182,6,14,1,255,203,7,0,1,255,224,8,14,1,255,203,9,0,1,255,224,10,245,0,255,245,11,246,0,255,243,12,245,
0,255,245,13,245,0,255,245,14,246,0,255,243,15,245,0,255,245,16,0,1,255,224,1,14,1,255,204,2,34,0,1,255,
225,3,0,1,255,225,4,245,0,255,245,5,34,1,255,179,6,16,1,255,200,7,2,34,1,255,221,8,16,1,255,200,9,2,34,
1,255,221,10,246,0,255,242,11,245,0,255,245,12,246,0,255,242,13,246,0,255,242,14,245,0,255,245,15,246,
0,255,242,16,2,34,1,255,221,1,12,1,255,207,2,34,254,0,255,227,3,254,0,255,227,4,243,0,255,248,5,37,1,
255,177,6,18,1,255,198,7,4,1,255,219,8,18,1,255,198,9,4,1,255,219,10,247,0,255,240,11,243,0,255,248,12,
247,0,255,240,13,247,0,255,240,14,243,0,255,248,15,247,0,255,240,16,4,1,255,219,1,10,1,255,209,2,34,253,
0,255,230,3,253,0,255,230,4,242,0,255,250,5,39,1,255,174,6,20,1,255,195,7,5,1,255,216,8,20,1,255,195,
9,5,1,255,216,10,249,0,255,237,11,242,0,255,250,12,249,0,255,237,13,249,0,255,237,14,242,0,255,250,15,
249,0,255,237,16,5,1,255,216,1,8,1,255,212,2,34,251,0,255,232,3,251,0,255,232,4,241,0,255,253,5,42,1,
255,172,6,22,1,255,193,7,7,1,255,214,8,22,1,255,193,9,7,1,255,214,10,250,0,255,235,11,241,0,255,253,12,
250,0,255,235,13,250,0,255,235,14,241,0,255,253,15,250,0,255,235,16,7,1,255,214,1,6,1,255,214,2,34,250,
0,255,235,3,250,0,255,235,4,240,0,255,255,5,45,1,255,172,6,25,1,255,190,7,9,1,255,211,8,25,1,255,190,
9,9,1,255,211,10,252,0,255,232,11,240,0,255,255,12,252,0,255,232,13,252,0,255,232,14,240,0,255,255,15,
252,0,255,232,16,9,1,255,211,1,5,1,255,217,2,34,249,0,255,238,3,249,0,255,238,4,241,0,255,253,5,47,1,
255,177,6,27,1,255,187,7,11,1,255,208,8,27,1,255,187,9,11,1,255,208,10,253,0,255,229,11,241,0,255,253,
12,253,0,255,229,13,253,0,255,229,14,241,0,255,253,15,253,0,255,229,16,11,1,255,208,1,3,1,255,220,2,34,
247,0,255,240,3,247,0,255,240,4,242,0,255,250,5,50,1,255,182,6,29,1,255,185,7,12,1,255,206,8,29,1,255,
185,9,12,1,255,206,10,255,0,255,227,11,242,0,255,250,12,255,0,255,227,13,255,0,255,227,14,242,0,255,250,
15,255,0,255,227,16,12,1,255,206,1,1,1,255,222,2,34,246,0,255,243,3,246,0,255,243,4,243,0,255,248,5,52,
1,255,188,6,32,1,255,182,7,14,1,255,203,8,32,1,255,182,9,14,1,255,203,10,0,1,255,224,11,243,0,255,248,
12,0,1,255,224,13,0,1,255,224,14,243,0,255,248,15,0,1,255,224,16,14,1,255,203,1,0,1,255,225,2,34,245,
0,255,245,3,245,0,255,245,4,245,0,255,245,5,54,1,255,193,6,34,1,255,179,7,16,1,255,200,8,34,1,255,179,
9,16,1,255,200,10,2,34,1,255,221,11,245,0,255,245,12,2,34,1,255,221,13,2,34,1,255,221,14,245,0,255,245,
15,2,34,1,255,221,16,16,1,255,200,1,254,0,255,227,2,34,243,0,255,248,3,243,0,255,248,4,246,0,255,242,
5,56,1,255,198,6,37,1,255,177,7,18,1,255,198,8,37,1,255,177,9,18,1,255,198,10,4,1,255,219,11,246,0,255,
242,12,4,1,255,219,13,4,1,255,219,14,246,0,255,242,15,4,1,255,219,16,18,1,255,198,1,253,0,255,230,2,34,
242,0,255,250,3,242,0,255,250,4,247,0,255,240,5,58,1,255,203,6,39,1,255,174,7,20,1,255,195,8,39,1,255,
174,9,20,1,255,195,10,5,1,255,216,11,247,0,255,240,12,5,1,255,216,13,5,1,255,216,14,247,0,255,240,15,
5,1,255,216,16,20,1,255,195,1,251,0,255,232,2,34,241,0,255,253,3,241,0,255,253,4,249,0,255,237,5,60,1,
255,208,6,42,1,255,172,7,22,1,255,193,8,42,1,255,172,9,22,1,255,193,10,7,1,255,214,11,249,0,255,237,12,
7,1,255,214,13,7,1,255,214,14,249,0,255,237,15,7,1,255,214,16,22,1,255,193,1,250,0,255,235,2,34,240,0,
255,255,3,240,0,255,255,4,250,0,255,235,5,62,1,255,214,6,45,1,255,174,7,25,1,255,190,8,45,1,255,174,9,
25,1,255,190,10,9,1,255,211,11,250,0,255,235,12,9,1,255,211,13,9,1,255,211,14,250,0,255,235,15,9,1,255,
211,16,25,1,255,190,1,249,0,255,238,2,34,241,0,255,253,3,241,0,255,253,4,252,0,255,232,5,64,1,255,219,
6,43,1,255,171,7,27,1,255,187,8,43,1,255,171,9,27,1,255,187,10,11,1,255,208,11,252,0,255,232,12,11,1,
255,208,13,11,1,255,208,14,252,0,255,232,15,11,1,255,208,16,27,1,255,187,1,247,0,255,240,2,34,242,0,255,
250,3,242,0,255,250,4,253,0,255,229,5,65,1,255,224,6,40,1,255,173,7,29,1,255,185,8,40,1,255,173,9,29,
1,255,185,10,12,1,255,206,11,253,0,255,229,12,12,1,255,206,13,12,1,255,206,14,253,0,255,229,15,12,1,255,
206,16,29,1,255,185,1,246,0,255,243,2,34,243,0,255,248,3,243,0,255,248,4,255,0,255,227,5,67,1,255,229,
6,38,1,255,176,7,32,1,255,182,8,38,1,255,176,9,32,1,255,182,10,14,1,255,203,11,255,0,255,227,12,14,1,
255,203,13,14,1,255,203,14,255,0,255,227,15,14,1,255,203,16,32,1,255,182,1,245,0,255,245,2,34,245,0,255,
245,3,245,0,255,245,4,0,1,255,224,5,68,1,255,235,6,35,1,255,178,7,34,1,255,179,8,35,1,255,178,9,34,1,
255,179,10,16,1,255,200,11,0,1,255,224,12,16,1,255,200,13,16,1,255,200,14,0,1,255,224,15,16,1,255,200,
16,34,1,255,179,1,243,0,255,248,2,34,246,0,255,242,3,246,0,255,242,4,2,34,1,255,221,5,70,1,255,240,6,
33,1,255,181,7,37,1,255,177,8,33,1,255,181,9,37,1,255,177,10,18,1,255,198,11,2,34,1,255,221,12,18,1,255,
198,13,18,1,255,198,14,2,34,1,255,221,15,18,1,255,198,16,37,1,255,177,1,242,0,255,250,2,34,247,0,255,
240,3,247,0,255,240,4,4,1,255,219,5,71,1,255,245,6,30,1,255,184,7,39,1,255,174,8,30,1,255,184,9,39,1,
255,174,10,20,1,255,195,11,4,1,255,219,12,20,1,255,195,13,20,1,255,195,14,4,1,255,219,15,20,1,255,195,
16,39,1,255,174,1,241,0,255,253,2,34,249,0,255,237,3,249,0,255,237,4,5,1,255,216,5,72,1,255,250,6,28,
1,255,186,7,42,1,255,172,8,28,1,255,186,9,42,1,255,172,10,22,1,255,193,11,5,1,255,216,12,22,1,255,193,
13,22,1,255,193,14,5,1,255,216,15,22,1,255,193,16,42,1,255,172,1,240,0,255,255,2,34,250,0,255,235,3,250,
0,255,235,4,7,1,255,214,5,74,1,255,255,6,26,1,255,189,7,45,1,255,172,8,26,1,255,189,9,45,1,255,172,10,
25,1,255,190,11,7,1,255,214,12,25,1,255,190,13,25,1,255,190,14,7,1,255,214,15,25,1,255,190,16,45,1,255,
172,69};
  
int ledMapping[][3] = {  
  { 41, 43, 42 },  { 22, 24, 23 },  { 19, 21, 20 },  { 16, 18, 17 }, 
  
  { 44, 46, 45 }, { 38, 40, 39  }, { 25, 27, 26 }, { 28, 30, 29 }, 
  
  { 32, 34, 33  }, { 0, 47, 31  }, { 4, 6, 5 }, { 1, 3, 2  },    
  
  { 35, 37, 36  },  { 7, 9, 8 }, { 10, 12, 11 }, { 13, 15, 14 }
};
  
struct animation {
  int numLeds;
  int numFrames;
  int frameFrequency;
} typedef Animation;

Animation anim;

void setup() {
  Serial.begin(9600);
  //Serial.print("woo");
  //Serial.print("\n");

  Tlc.init();
  Tlc.clear();
  Tlc.update();

  Serial.print("woo");
  Serial.print("\n");

  gHaveCode = true;
}

void loop() {
  if(gHaveCode) {
    int next = 0;
    unsigned int val;
    int k;    // counter variable

    readAnimation(&next);

    next = 0;
  } else {
    testLoop();
  }
}

void readAnimation(int* nextByte) {
  unsigned char header = readByteProgmem(nextByte);
    Serial.print("header is ");
   Serial.print(header, HEX);
    Serial.print("\n");
    
    byte numLedsHigh = readByteProgmem(nextByte);
    byte numLedsLow = readByteProgmem(nextByte);
    anim.numLeds = numLedsHigh |= numLedsLow << 8;
    //anim.numLeds = readByteProgmem(nextByte);
    readByteProgmem(nextByte);
    readByteProgmem(nextByte);
    anim.numFrames = readByteProgmem(nextByte);
    anim.frameFrequency = readByteProgmem(nextByte);
    
    unsigned int frame = 0;
    int framecounter = 0;
    while(framecounter++ < anim.numFrames) {
      Serial.print("frame ");
     Serial.print(framecounter, DEC);
      Serial.print("\n");

      unsigned char led = 0;
      int ledcounter = 0;

      while(ledcounter < anim.numLeds){
        Serial.print("led ");
        Serial.print(ledcounter, DEC);
        Serial.print("\n");

        readAndSetColour(nextByte, ledcounter++);
      }

      Tlc.update();
      delay(anim.frameFrequency);
    }
    //unsigned char ledRows = readByteProgmem(&next);
    //Serial.print("led rows are ");
    //Serial.print(ledRows, DEC);
   // Serial.print("\n");
    
    //unsigned char ledColumns = readByteProgmem(&next);
   // Serial.print("led columns are ");
   // Serial.print(ledColumns, DEC);
   // Serial.print("\n");
    
   // unsigned int ledCount = ledColumns*ledRows;

   // unsigned char frameCount = readByteProgmem(&next);
   // Serial.print("frame count is ");
   // Serial.print(frameCount, DEC);
   // Serial.print("\n");

 // unsigned char frameFrequency = readByteProgmem(&next);
}

void testLoop() {
  for(int i = 0; i < 16; i++) {
     // setColour(i, 256, 256, 256);
       
       //Tlc.update();
      Serial.print(i, DEC);
       
       delay(500);
       setColour(i, 256, 0, 0);
       
       Tlc.update();
       
       delay(500);        
       
       setColour(i, 0, 256, 0);
       
       Tlc.update();
       
       delay(500);        
       
       setColour(i, 0, 0, 256);
       
       Tlc.update();
       
       delay(500);
       
       setColour(i, 256, 256, 256);
       
       Tlc.update();
    }
}

void readAndSetColour(int* aPosition, unsigned char aLed)
{
  /*Serial.print("next is ");
   Serial.print(*aPosition, DEC);
   Serial.print("\n");*/

  unsigned char red = readByteProgmem(aPosition);
  unsigned char green = readByteProgmem(aPosition);
  unsigned char blue = readByteProgmem(aPosition);

  Serial.print("colour is ");
   Serial.print(red, DEC);
   Serial.print(" ");
   Serial.print(green, DEC);
   Serial.print(" ");
   Serial.print(blue, DEC);
   Serial.print("\n");
  unsigned int red12 = pgm_read_word_near(gammaCorrection + red);
  unsigned int green12 = pgm_read_word_near(gammaCorrection + green);
  unsigned int blue12 = pgm_read_word_near(gammaCorrection + blue);

  setColour(aLed, red12, green12, blue12);
}

void setColour(unsigned char aLed, int aRed, int aGreen, int aBlue)
{
  /*Serial.print("setColour ");
   Serial.print(aLed, DEC);
   Serial.print("\n");*/
  // int boardMultiplier = (aLed/16) * 48;
  /*Serial.print("boardMultiplier ");
   Serial.print(boardMultiplier, DEC);
   Serial.print("\n");*/
  Tlc.set(ledMapping[aLed][0], aRed);
  Tlc.set(ledMapping[aLed][1], aGreen);
  Tlc.set(ledMapping[aLed][2], aBlue);
}

unsigned int readByteProgmem(int* aPosition)
{
  // Serial.print("position is (1) ");
  //   Serial.print(*aPosition, DEC);
  // Serial.print("\n");

  unsigned char readByte = pgm_read_byte_near(animation1 + (*(aPosition))++);
  // Serial.print("int is ");
  // Serial.print(integer, DEC);
  //Serial.print("\n");
  //Serial.print("position is (2) ");
  //Serial.print(*aPosition, DEC);
  //Serial.print("\n");

  if(readByte == 0x02) {
    readByte = pgm_read_byte_near(animation1 + (*(aPosition))++);
    //Serial.print("escaped int is ");
    //Serial.print(integer, DEC);
    //Serial.print("\n");
    //Serial.print("position is (3) ");
    // Serial.print(*aPosition, DEC);
    //Serial.print("\n");

    readByte = readByte ^ 0x20;
    //Serial.print("new int is ");
    //Serial.print(integer, DEC);
    //Serial.print("\n");
  }

  return readByte;
}

void hSVtoRGB(int hue, char sat, char val, char* red, char* green, char* blue) {
  RgbColor rgb;
    unsigned char region, remainder, p, q, t;

    if (hsv.s == 0)
    {
        rgb.r = hsv.v;
        rgb.g = hsv.v;
        rgb.b = hsv.v;
        return rgb;
    }

    region = hsv.h / 43;
    remainder = (hsv.h - (region * 43)) * 6; 

    p = (hsv.v * (255 - hsv.s)) >> 8;
    q = (hsv.v * (255 - ((hsv.s * remainder) >> 8))) >> 8;
    t = (hsv.v * (255 - ((hsv.s * (255 - remainder)) >> 8))) >> 8;

    switch (region)
    {
        case 0:
            rgb.r = hsv.v; rgb.g = t; rgb.b = p;
            break;
        case 1:
            rgb.r = q; rgb.g = hsv.v; rgb.b = p;
            break;
        case 2:
            rgb.r = p; rgb.g = hsv.v; rgb.b = t;
            break;
        case 3:
            rgb.r = p; rgb.g = q; rgb.b = hsv.v;
            break;
        case 4:
            rgb.r = t; rgb.g = p; rgb.b = hsv.v;
            break;
        default:
            rgb.r = hsv.v; rgb.g = p; rgb.b = q;
            break;
    }

    return rgb;
}

byte readByteSerial()
{
  int incoming;
  do
  {
    incoming = Serial.read();
    // Serial.print("1:");
    // Serial.print(incoming, HEX);
    //Serial.print("\n");
  }
  while(incoming < 0);

  if(incoming == 0x02)
  {
    do
    {
      incoming = Serial.read();
      // Serial.print("2:");
      // Serial.print(incoming, HEX);
      // Serial.print("\n");
    }
    while(incoming < 0);
    byte incomingbyte = (byte)(incoming) ^ 0x20;
    //  Serial.print("3:");
    //  Serial.print(incomingbyte, HEX);
    // Serial.print("\n");
    return incomingbyte;
  }
  else
  {
    // Serial.print("4:");
    // Serial.print(incoming, HEX);
    //Serial.print("\n");

    return (byte)incoming;
  }
}







